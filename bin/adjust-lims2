#!/bin/bash

APP_DIR=$(dirname $(dirname $0))
TEMPLATE=$APP_DIR/template

if [ $# -eq 0 ]; then
	echo "Usage: $(basename $0) <config file>"
	exit 1
fi

arg=$(readlink -e $1)

if [ -z "$arg" ]; then
	echo "cannot access $1: No such file or directory"
	exit 3
elif [ -d "$arg" ]; then
	ROOT_DIR=$arg
	CONFIG=$arg/LIMS2file
elif [ -e "$arg" ]; then
	ROOT_DIR=$(dirname $arg)
	CONFIG=$arg
fi

cd "$ROOT_DIR" || exit 2

. $CONFIG

if [ -z "$SITE_ID" ]
then
	echo 'empty $SITE_ID'
	exit 1
fi

if [ -z "$LAB_ID" ]
then
	echo 'empty $LAB_ID'
	exit 1
fi

: ${CONTAINER_NAME:=$(basename $ROOT_DIR)}

: ${SRC_DIR:="${ROOT_DIR}/src"}
: ${TARGET_DIR:="${ROOT_DIR}/data"}
: ${RUN_DIR:="${ROOT_DIR}/run"}

export DOCKER_LIMS2_DIR=/usr/share/lims2
export DOCKER_NODE_LIMS2_DIR=/home/genee/node-lims2
export DOCKER_NODE_LIMS2_LOG_DIR=/var/log/node-lims2
export DOCKER_GLOGON_SERVER_DIR=/home/genee/glogon-server
export DOCKER_GDOOR_SERVER_DIR=/home/genee/gdoor-server
export DOCKER_EPC_SERVER_DIR=/home/genee/epc-server
export DOCKER_ICCO_SERVER_DIR=/home/genee/icco-server
export DOCKER_ENV_SERVER_DIR=/home/genee/env-server
export DOCKER_CACS_SERVER_DIR=/home/genee/cacs-server
export DOCKER_RESERV_SERVER_DIR=/home/genee/reserv-server

export DOCKER_SSH_PORT=22
export DOCKER_GLOGON_PORT=2430
export DOCKER_EPC_PORT=3041
export DOCKER_ICCO_SERVER_PORT=2333
export DOCKER_ICCO_AGENT_PORT=2332
export DOCKER_ENV_PORT=3741
export DOCKER_CACS_PORT=2530
export DOCKER_VIDCAM_PORT=5824
export DOCKER_GDOOR_PORT=2930
export DOCKER_GDOOR_API_PORT=2950
export DOCKER_RESERV_PORT=9898

GLOGON_PUB_PORT=$(docker port ${CONTAINER_NAME} ${DOCKER_GLOGON_PORT} | sed 's/[^:]*://')
sudo docker-enter "${CONTAINER_NAME}" env SITE_ID=$SITE_ID LAB_ID=$LAB_ID DOCKER_LIMS2_DIR=$DOCKER_LIMS2_DIR GLOGON_PUB_PORT=$GLOGON_PUB_PORT /data/bin/update-glogon-port.sh
GDOOR_PUB_PORT=$(docker port ${CONTAINER_NAME} ${DOCKER_GDOOR_PORT} | sed 's/[^:]*://')
GDOOR_API_PUB_PORT=$(docker port ${CONTAINER_NAME} ${DOCKER_GDOOR_API_PORT} | sed 's/[^:]*://')
sudo docker-enter "${CONTAINER_NAME}" env SITE_ID=$SITE_ID LAB_ID=$LAB_ID DOCKER_LIMS2_DIR=$DOCKER_LIMS2_DIR GDOOR_PUB_PORT=$GDOOR_PUB_PORT  GDOOR_API_PUB_PORT=$GDOOR_API_PUB_PORT DOCKER_GDOOR_SERVER_DIR=$DOCKER_GDOOR_SERVER_DIR /data/bin/update-gdoor-port.sh
RESERV_PUB_PORT=$(docker port ${CONTAINER_NAME} ${DOCKER_RESERV_PORT} | sed 's/[^:]*://')
sudo docker-enter "${CONTAINER_NAME}" env SITE_ID=$SITE_ID LAB_ID=$LAB_ID DOCKER_LIMS2_DIR=$DOCKER_LIMS2_DIR RESERV_PUB_PORT=$RESERV_PUB_PORT /data/bin/update-reserv-port.sh
WEB_PUB_PORT=$(docker port ${CONTAINER_NAME} 80 | sed 's/[^:]*://')
sudo docker-enter "${CONTAINER_NAME}" env SITE_ID=$SITE_ID LAB_ID=$LAB_ID DOCKER_LIMS2_DIR=$DOCKER_LIMS2_DIR WEB_PUB_PORT=$WEB_PUB_PORT /data/bin/update-web-port.sh
sudo docker-enter "${CONTAINER_NAME}" supervisorctl restart php7-fpm nginx
sudo docker-enter "${CONTAINER_NAME}" env DOCKER_NODE_LIMS2_DIR=$DOCKER_NODE_LIMS2_DIR DOCKER_NODE_LIMS2_LOG_DIR=$DOCKER_NODE_LIMS2_LOG_DIR /data/bin/init-node-lims2.sh

